--// Bundle Equipper v4 â€” Full R6 + R15 + Delta Fix
--// Complete rewrite of equip logic

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")
local player = Players.LocalPlayer

---------------------------------------------------------------
-- EXECUTOR DETECTION
---------------------------------------------------------------
local execName = "Unknown"
pcall(function()
    if identifyexecutor then
        execName = identifyexecutor()
    elseif syn then execName = "Synapse"
    elseif delta then execName = "Delta"
    elseif fluxus then execName = "Fluxus"
    elseif KRNL_LOADED then execName = "KRNL"
    end
end)

---------------------------------------------------------------
-- FORCE SET LOCKED PROPERTY (MeshId, etc)
---------------------------------------------------------------
local function forceSet(obj, prop, value)
    local s1 = pcall(function() obj[prop] = value end)
    if s1 then return true end

    if sethiddenproperty then
        local s2 = pcall(sethiddenproperty, obj, prop, value)
        if s2 then return true end
    end

    if setscriptable then
        local s3 = pcall(function()
            local old = setscriptable(obj, prop, true)
            obj[prop] = value
            setscriptable(obj, prop, old)
        end)
        if s3 then return true end
    end

    return false
end

---------------------------------------------------------------
-- LOAD ASSET OBJECTS
---------------------------------------------------------------
local function loadAsset(id)
    local ok, objs = pcall(game.GetObjects, game, "rbxassetid://" .. tostring(id))
    if ok and objs and #objs > 0 then return objs end
    return nil
end

---------------------------------------------------------------
-- GET BUNDLE DETAILS
---------------------------------------------------------------
local function getBundleInfo(bundleId)
    -- Try AssetService
    local ok, info = pcall(function()
        return game:GetService("AssetService"):GetBundleDetailsAsync(bundleId)
    end)
    if ok and info and info.Items then return info end

    -- HTTP fallback
    local urls = {
        "https://catalog.roproxy.com/v1/bundles/" .. bundleId .. "/details",
    }
    for _, url in ipairs(urls) do
        local ok2, body = pcall(function()
            if request then return request({Url=url}).Body end
            if http_request then return http_request({Url=url}).Body end
            if syn and syn.request then return syn.request({Url=url}).Body end
            if game.HttpGet then return game:HttpGet(url) end
        end)
        if ok2 and body then
            local ok3, data = pcall(HttpService.JSONDecode, HttpService, body)
            if ok3 and data then
                if data[1] then data = data[1] end
                local items = {}
                for _, v in ipairs(data.items or {}) do
                    table.insert(items, {Id = v.id, Name = v.name or "", Type = v.type or ""})
                end
                return {Name = data.name or "Bundle", Items = items}
            end
        end
    end
    return nil
end

---------------------------------------------------------------
-- R15 PART NAMES
---------------------------------------------------------------
local R15_NAMES = {
    "Head","UpperTorso","LowerTorso",
    "LeftUpperArm","LeftLowerArm","LeftHand",
    "RightUpperArm","RightLowerArm","RightHand",
    "LeftUpperLeg","LeftLowerLeg","LeftFoot",
    "RightUpperLeg","RightLowerLeg","RightFoot",
}
local R15_SET = {}
for _,v in ipairs(R15_NAMES) do R15_SET[v] = true end

---------------------------------------------------------------
-- R6 BodyPart enum mapping
---------------------------------------------------------------
local R6_BODYPART_MAP = {
    [Enum.BodyPart.Torso] = "Torso",
    [Enum.BodyPart.LeftArm] = "Left Arm",
    [Enum.BodyPart.RightArm] = "Right Arm",
    [Enum.BodyPart.LeftLeg] = "Left Leg",
    [Enum.BodyPart.RightLeg] = "Right Leg",
}

---------------------------------------------------------------
-- DEEP SCAN: Find all usable parts in loaded objects
---------------------------------------------------------------
local function deepScan(objects)
    local r15Parts = {}     -- name -> MeshPart
    local charMeshes = {}   -- list of CharacterMesh
    local specMeshes = {}   -- parent name -> SpecialMesh
    local faces = {}        -- list of Decals
    local debugLog = {}

    local function scan(obj, path)
        path = path or obj.Name

        if obj:IsA("MeshPart") then
            -- Check exact R15 name
            if R15_SET[obj.Name] then
                r15Parts[obj.Name] = obj
                table.insert(debugLog, "R15 MeshPart: " .. obj.Name .. " @ " .. path)
            else
                -- Check if parent folder name gives a hint
                -- Some assets name the MeshPart differently but it's inside a named folder
                table.insert(debugLog, "MeshPart (non-R15 name): " .. obj.Name .. " @ " .. path)
            end
        end

        if obj:IsA("CharacterMesh") then
            table.insert(charMeshes, obj)
            local bpName = "?"
            pcall(function() bpName = tostring(obj.BodyPart) end)
            table.insert(debugLog, "CharacterMesh: " .. bpName .. " @ " .. path)
        end

        if obj:IsA("SpecialMesh") then
            local pName = (obj.Parent and obj.Parent.Name) or "unknown"
            specMeshes[pName] = obj
            table.insert(debugLog, "SpecialMesh in " .. pName .. " @ " .. path)
        end

        if obj:IsA("Decal") and (obj.Name:lower() == "face") then
            table.insert(faces, obj)
            table.insert(debugLog, "Face Decal @ " .. path)
        end

        for _, child in ipairs(obj:GetChildren()) do
            scan(child, path .. "/" .. child.Name)
        end
    end

    for _, obj in ipairs(objects) do
        scan(obj, obj.Name)
    end

    return r15Parts, charMeshes, specMeshes, faces, debugLog
end

---------------------------------------------------------------
-- APPLY R15 MESH SWAP
---------------------------------------------------------------
local function applyR15(r15Parts, specMeshes, faces, character)
    local applied = 0

    for name, source in pairs(r15Parts) do
        local target = character:FindFirstChild(name)
        if target and target:IsA("MeshPart") then
            local meshId = ""
            pcall(function() meshId = source.MeshId end)
            if meshId ~= "" and forceSet(target, "MeshId", meshId) then
                applied += 1
                pcall(function()
                    if source.TextureID ~= "" then
                        target.TextureID = source.TextureID
                    end
                end)
                pcall(function() target.Size = source.Size end)
                pcall(function() target.Color = source.Color end)

                -- SurfaceAppearance
                local oldSA = target:FindFirstChildOfClass("SurfaceAppearance")
                local newSA = source:FindFirstChildOfClass("SurfaceAppearance")
                if oldSA then oldSA:Destroy() end
                if newSA then newSA:Clone().Parent = target end

                -- WrapTarget
                local oldW = target:FindFirstChildOfClass("WrapTarget")
                local newW = source:FindFirstChildOfClass("WrapTarget")
                if oldW then oldW:Destroy() end
                if newW then newW:Clone().Parent = target end
            end
        end
    end

    -- Head SpecialMesh
    local headMesh = specMeshes["Head"]
    if headMesh then
        local head = character:FindFirstChild("Head")
        if head then
            local existing = head:FindFirstChildOfClass("SpecialMesh")
            if existing then
                pcall(function() existing.MeshId = headMesh.MeshId end)
                pcall(function() existing.TextureId = headMesh.TextureId end)
                pcall(function() existing.Scale = headMesh.Scale end)
                pcall(function() existing.Offset = headMesh.Offset end)
            else
                pcall(function() headMesh:Clone().Parent = head end)
            end
            applied += 1
        end
    end

    -- Face
    for _, decal in ipairs(faces) do
        local head = character:FindFirstChild("Head")
        if head then
            local face = head:FindFirstChild("face") or head:FindFirstChild("Face")
            if face and face:IsA("Decal") then
                pcall(function() face.Texture = decal.Texture end)
                applied += 1
            end
        end
    end

    return applied
end

---------------------------------------------------------------
-- APPLY R6 MESH SWAP
---------------------------------------------------------------
local function applyR6(charMeshes, specMeshes, faces, r15Parts, character)
    local applied = 0

    -- Direct CharacterMesh application
    for _, cm in ipairs(charMeshes) do
        -- Remove existing CharacterMesh with same BodyPart
        for _, existing in ipairs(character:GetChildren()) do
            if existing:IsA("CharacterMesh") then
                pcall(function()
                    if existing.BodyPart == cm.BodyPart then
                        existing:Destroy()
                    end
                end)
            end
        end
        pcall(function()
            local clone = cm:Clone()
            clone.Parent = character
            applied += 1
        end)
    end

    -- Head SpecialMesh
    local headMesh = specMeshes["Head"]
    if headMesh then
        local head = character:FindFirstChild("Head")
        if head then
            local existing = head:FindFirstChildOfClass("SpecialMesh")
            if existing then
                pcall(function() existing.MeshId = headMesh.MeshId end)
                pcall(function() existing.TextureId = headMesh.TextureId end)
                pcall(function() existing.Scale = headMesh.Scale end)
                pcall(function() existing.Offset = headMesh.Offset end)
            else
                pcall(function() headMesh:Clone().Parent = head end)
            end
            applied += 1
        end
    end

    -- If no CharacterMeshes found but R15 parts exist,
    -- try to convert R15 mesh IDs into R6 SpecialMesh overlays
    if #charMeshes == 0 and next(r15Parts) then
        -- Try converting: add SpecialMesh to R6 Parts
        local r6Mapping = {
            ["UpperTorso"] = "Torso", ["LowerTorso"] = "Torso",
            ["LeftUpperArm"] = "Left Arm", ["LeftLowerArm"] = "Left Arm", ["LeftHand"] = "Left Arm",
            ["RightUpperArm"] = "Right Arm", ["RightLowerArm"] = "Right Arm", ["RightHand"] = "Right Arm",
            ["LeftUpperLeg"] = "Left Leg", ["LeftLowerLeg"] = "Left Leg", ["LeftFoot"] = "Left Leg",
            ["RightUpperLeg"] = "Right Leg", ["RightLowerLeg"] = "Right Leg", ["RightFoot"] = "Right Leg",
            ["Head"] = "Head",
        }

        -- For R6 we pick just the main R15 part per R6 limb
        local primaryR15 = {
            ["Torso"] = "UpperTorso",
            ["Left Arm"] = "LeftUpperArm",
            ["Right Arm"] = "RightUpperArm",
            ["Left Leg"] = "LeftUpperLeg",
            ["Right Leg"] = "RightUpperLeg",
            ["Head"] = "Head",
        }

        for r6Name, r15Name in pairs(primaryR15) do
            local source = r15Parts[r15Name]
            if source then
                local target = character:FindFirstChild(r6Name)
                if target and target:IsA("BasePart") then
                    local meshId = ""
                    pcall(function() meshId = source.MeshId end)
                    if meshId ~= "" then
                        local existing = target:FindFirstChildOfClass("SpecialMesh")
                        if existing then
                            pcall(function() existing.MeshId = meshId end)
                            pcall(function()
                                if source.TextureID ~= "" then
                                    existing.TextureId = source.TextureID
                                end
                            end)
                        else
                            pcall(function()
                                local sm = Instance.new("SpecialMesh")
                                sm.MeshType = Enum.MeshType.FileMesh
                                sm.MeshId = meshId
                                if source.TextureID and source.TextureID ~= "" then
                                    sm.TextureId = source.TextureID
                                end
                                sm.Parent = target
                            end)
                        end
                        applied += 1
                    end
                end
            end
        end
    end

    -- Face
    for _, decal in ipairs(faces) do
        local head = character:FindFirstChild("Head")
        if head then
            local face = head:FindFirstChild("face") or head:FindFirstChild("Face")
            if face and face:IsA("Decal") then
                pcall(function() face.Texture = decal.Texture end)
                applied += 1
            end
        end
    end

    return applied
end

---------------------------------------------------------------
-- DESCRIPTION METHOD: FULL APPLY
---------------------------------------------------------------
local function applyDescriptionFull(outfitId, humanoid)
    local desc = Players:GetHumanoidDescriptionFromOutfitId(outfitId)
    humanoid:ApplyDescription(desc)
    return true
end

---------------------------------------------------------------
-- DESCRIPTION METHOD: BODY ONLY (keep clothes/accessories)
---------------------------------------------------------------
local function applyDescriptionBodyOnly(outfitId, humanoid)
    local bundleDesc = Players:GetHumanoidDescriptionFromOutfitId(outfitId)
    local currentDesc = humanoid:GetAppliedDescription()

    -- Copy ALL body properties unconditionally
    local meshProps = {"Head","Torso","LeftArm","RightArm","LeftLeg","RightLeg"}
    for _, prop in ipairs(meshProps) do
        pcall(function()
            currentDesc[prop] = bundleDesc[prop]
        end)
    end

    -- Face
    pcall(function() currentDesc.Face = bundleDesc.Face end)

    -- Scales
    local scaleProps = {
        "BodyTypeScale","ProportionScale","HeadScale",
        "DepthScale","HeightScale","WidthScale"
    }
    for _, prop in ipairs(scaleProps) do
        pcall(function()
            currentDesc[prop] = bundleDesc[prop]
        end)
    end

    -- Body colors
    local colorProps = {
        "HeadColor","TorsoColor","LeftArmColor",
        "RightArmColor","LeftLegColor","RightLegColor"
    }
    for _, prop in ipairs(colorProps) do
        pcall(function()
            currentDesc[prop] = bundleDesc[prop]
        end)
    end

    humanoid:ApplyDescription(currentDesc)
    return true
end

---------------------------------------------------------------
-- MAIN EQUIP FUNCTION: BUNDLE
---------------------------------------------------------------
local keepClothes = false -- toggled by UI

local function equipBundle(bundleId, log)
    local char = player.Character
    if not char then error("No character") end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then error("No humanoid") end
    local isR15 = hum.RigType == Enum.HumanoidRigType.R15

    log("Fetching bundle " .. bundleId .. "...", Color3.fromRGB(255, 220, 80))
    local info = getBundleInfo(bundleId)
    if not info then error("Cannot get bundle info for " .. bundleId) end
    local name = info.Name or "Bundle"
    log("Found: " .. name .. " (" .. #info.Items .. " items)", Color3.fromRGB(255, 220, 80))

    -- Gather asset IDs and outfit ID
    local assetIds = {}
    local outfitId = nil
    for _, item in ipairs(info.Items) do
        if item.Type == "UserOutfit" then outfitId = item.Id end
        if item.Type == "Asset" then table.insert(assetIds, item.Id) end
    end

    -- METHOD 1: HumanoidDescription
    if outfitId then
        log("Trying Description method (outfit " .. outfitId .. ")...", Color3.fromRGB(255, 220, 80))
        local descOk, descErr
        if keepClothes then
            descOk, descErr = pcall(applyDescriptionBodyOnly, outfitId, hum)
        else
            descOk, descErr = pcall(applyDescriptionFull, outfitId, hum)
        end
        if descOk then
            return name, "HumanoidDescription"
        end
        log("Description failed: " .. tostring(descErr), Color3.fromRGB(255, 150, 50))
    end

    -- METHOD 2: Mesh Swap
    log("Trying mesh swap (" .. #assetIds .. " assets)...", Color3.fromRGB(255, 220, 80))
    local totalApplied = 0
    local allDebug = {}

    for i, assetId in ipairs(assetIds) do
        log(string.format("Asset %d/%d (ID %d)...", i, #assetIds, assetId), Color3.fromRGB(255, 220, 80))
        local objs = loadAsset(assetId)
        if objs then
            local r15Parts, charMeshes, specMeshes, faces, debugLog = deepScan(objs)
            for _, d in ipairs(debugLog) do table.insert(allDebug, d) end

            local count = 0
            if isR15 then
                count = applyR15(r15Parts, specMeshes, faces, char)
            else
                count = applyR6(charMeshes, specMeshes, faces, r15Parts, char)
            end
            totalApplied += count

            for _, o in ipairs(objs) do pcall(game.Destroy, o) end
        else
            table.insert(allDebug, "FAILED to load asset " .. assetId)
        end
    end

    if totalApplied > 0 then
        return name, "MeshSwap (" .. totalApplied .. " parts)"
    end

    -- Show what was found for debugging
    local debugStr = table.concat(allDebug, "\n")
    error("0 parts applied.\nRig: " .. (isR15 and "R15" or "R6") ..
        "\nScanned " .. #assetIds .. " assets\nFound:\n" .. debugStr)
end

---------------------------------------------------------------
-- MAIN EQUIP FUNCTION: SINGLE ASSET
---------------------------------------------------------------
local function equipAsset(assetId, log)
    local char = player.Character
    if not char then error("No character") end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then error("No humanoid") end
    local isR15 = hum.RigType == Enum.HumanoidRigType.R15

    log("Loading asset " .. assetId .. "...", Color3.fromRGB(255, 220, 80))
    local objs = loadAsset(assetId)
    if not objs then error("game:GetObjects failed for " .. assetId) end

    local r15Parts, charMeshes, specMeshes, faces, debugLog = deepScan(objs)

    log("Scan: " .. #debugLog .. " items found", Color3.fromRGB(255, 220, 80))

    local count = 0
    if isR15 then
        count = applyR15(r15Parts, specMeshes, faces, char)
    else
        count = applyR6(charMeshes, specMeshes, faces, r15Parts, char)
    end

    for _, o in ipairs(objs) do pcall(game.Destroy, o) end

    if count > 0 then
        return "Asset " .. assetId, "MeshSwap (" .. count .. " parts)"
    end

    local debugStr = table.concat(debugLog, "\n")
    error("0 parts applied.\nRig: " .. (isR15 and "R15" or "R6") .. "\nFound:\n" .. debugStr)
end

---------------------------------------------------------------
-- AUTO EQUIP (bundle or asset)
---------------------------------------------------------------
local function equipAny(id, log)
    -- Try bundle
    log("Trying as bundle...", Color3.fromRGB(255, 220, 80))
    local bOk, bName, bMethod = pcall(equipBundle, id, log)
    if bOk then return bName, bMethod end

    -- Try asset
    log("Not a bundle, trying as asset...", Color3.fromRGB(255, 180, 50))
    local aOk, aName, aMethod = pcall(equipAsset, id, log)
    if aOk then return aName, aMethod end

    error("Bundle: " .. tostring(bName) .. "\nAsset: " .. tostring(aName))
end

---------------------------------------------------------------
-- HEADLESS
---------------------------------------------------------------
local function doHeadless()
    local char = player.Character
    if not char then error("No character") end
    local head = char:FindFirstChild("Head")
    if not head then error("No head") end

    head.Transparency = 1
    if head:IsA("MeshPart") then
        forceSet(head, "MeshId", "")
    end

    for _, c in ipairs(head:GetChildren()) do
        if c:IsA("Decal") then c.Transparency = 1 end
        if c:IsA("SpecialMesh") then
            pcall(function() c.Scale = Vector3.zero end)
            pcall(function() c.MeshId = "" end)
        end
    end

    for _, acc in ipairs(char:GetChildren()) do
        if acc:IsA("Accessory") then
            local handle = acc:FindFirstChild("Handle")
            if handle then
                local headAcc = false
                for _, att in ipairs(handle:GetChildren()) do
                    if att:IsA("Attachment") then
                        local n = att.Name:lower()
                        if n:find("hat") or n:find("hair") or n:find("head") or n:find("face") then
                            headAcc = true
                            break
                        end
                    end
                end
                if not headAcc then
                    pcall(function()
                        if head and (handle.Position - head.Position).Magnitude < 3 then
                            headAcc = true
                        end
                    end)
                end
                if headAcc then
                    handle.Transparency = 1
                    for _, m in ipairs(handle:GetChildren()) do
                        if m:IsA("SpecialMesh") then
                            pcall(function() m.Scale = Vector3.zero end)
                        end
                        if m:IsA("MeshPart") then
                            m.Transparency = 1
                        end
                    end
                end
            end
        end
    end
end

---------------------------------------------------------------
-- RESET AVATAR
---------------------------------------------------------------
local function doReset()
    local char = player.Character
    if not char then error("No character") end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then error("No humanoid") end
    local desc = Players:GetHumanoidDescriptionFromUserId(player.UserId)
    hum:ApplyDescription(desc)
end

---------------------------------------------------------------
-- GUI
---------------------------------------------------------------
local gui = Instance.new("ScreenGui")
gui.Name = "BundleV4"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
if syn and syn.protect_gui then pcall(syn.protect_gui, gui) end
if protect_gui then pcall(protect_gui, gui) end

local main = Instance.new("Frame")
main.Size = UDim2.new(0, 350, 0, 355)
main.Position = UDim2.new(0.5, -175, 0, 20)
main.BackgroundColor3 = Color3.fromRGB(16, 16, 24)
main.BorderSizePixel = 0
main.Active = true
main.Draggable = true
main.Parent = gui
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)

local borderStroke = Instance.new("UIStroke")
borderStroke.Color = Color3.fromRGB(90, 50, 200)
borderStroke.Thickness = 1.5
borderStroke.Parent = main

-- TITLE
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 38)
titleBar.BackgroundColor3 = Color3.fromRGB(22, 22, 34)
titleBar.BorderSizePixel = 0
titleBar.Parent = main
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 12)
local tFix = Instance.new("Frame")
tFix.Size = UDim2.new(1, 0, 0, 12)
tFix.Position = UDim2.new(0, 0, 1, -12)
tFix.BackgroundColor3 = titleBar.BackgroundColor3
tFix.BorderSizePixel = 0
tFix.Parent = titleBar

Instance.new("TextLabel", titleBar).Size = UDim2.new(1, -80, 1, 0)
local tLabel = titleBar:FindFirstChildOfClass("TextLabel")
tLabel.Position = UDim2.new(0, 14, 0, 0)
tLabel.BackgroundTransparency = 1
tLabel.Text = "ðŸŽ­ Bundle Equipper v4"
tLabel.TextColor3 = Color3.new(1, 1, 1)
tLabel.TextSize = 15
tLabel.Font = Enum.Font.GothamBold
tLabel.TextXAlignment = Enum.TextXAlignment.Left

local execLabel = Instance.new("TextLabel", titleBar)
execLabel.Size = UDim2.new(0, 60, 0, 14)
execLabel.Position = UDim2.new(1, -100, 0, 12)
execLabel.BackgroundTransparency = 1
execLabel.Text = execName
execLabel.TextColor3 = Color3.fromRGB(80, 200, 80)
execLabel.TextSize = 10
execLabel.Font = Enum.Font.GothamBold
execLabel.TextXAlignment = Enum.TextXAlignment.Right

local closeBtn = Instance.new("TextButton", titleBar)
closeBtn.Size = UDim2.new(0, 28, 0, 28)
closeBtn.Position = UDim2.new(1, -34, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
closeBtn.BorderSizePixel = 0
closeBtn.Text = "âœ•"
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.TextSize = 12
closeBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)

-- CONTENT
local c = Instance.new("Frame", main)
c.Name = "Content"
c.Size = UDim2.new(1, -24, 1, -50)
c.Position = UDim2.new(0, 12, 0, 44)
c.BackgroundTransparency = 1

-- Rig type indicator
local rigLabel = Instance.new("TextLabel", c)
rigLabel.Size = UDim2.new(1, 0, 0, 14)
rigLabel.BackgroundTransparency = 1
rigLabel.TextSize = 10
rigLabel.Font = Enum.Font.GothamBold
rigLabel.TextXAlignment = Enum.TextXAlignment.Left
rigLabel.TextColor3 = Color3.fromRGB(120, 120, 150)

local function updateRigLabel()
    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if hum then
        local rig = hum.RigType == Enum.HumanoidRigType.R15 and "R15" or "R6"
        rigLabel.Text = "YOUR RIG: " .. rig .. "  |  ENTER BUNDLE OR ASSET ID:"
        rigLabel.TextColor3 = hum.RigType == Enum.HumanoidRigType.R15
            and Color3.fromRGB(80, 180, 255) or Color3.fromRGB(255, 180, 80)
    else
        rigLabel.Text = "ENTER BUNDLE ID OR ASSET ID:"
        rigLabel.TextColor3 = Color3.fromRGB(120, 120, 150)
    end
end
updateRigLabel()
player.CharacterAdded:Connect(function(ch)
    ch:WaitForChild("Humanoid")
    task.wait(0.5)
    updateRigLabel()
end)

-- TEXT BOX
local textBox = Instance.new("TextBox", c)
textBox.Size = UDim2.new(1, 0, 0, 38)
textBox.Position = UDim2.new(0, 0, 0, 18)
textBox.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
textBox.BorderSizePixel = 0
textBox.PlaceholderText = "e.g. 193 (Headless) 154 (Korblox) 139607718"
textBox.PlaceholderColor3 = Color3.fromRGB(85, 85, 110)
textBox.Text = ""
textBox.TextColor3 = Color3.new(1, 1, 1)
textBox.TextSize = 15
textBox.Font = Enum.Font.GothamBold
textBox.ClearTextOnFocus = false
Instance.new("UICorner", textBox).CornerRadius = UDim.new(0, 8)
local tbPad = Instance.new("UIPadding", textBox)
tbPad.PaddingLeft = UDim.new(0, 12)
tbPad.PaddingRight = UDim.new(0, 12)
Instance.new("UIStroke", textBox).Color = Color3.fromRGB(55, 55, 80)

-- ROW 1: Equip + Reset
local equipBtn = Instance.new("TextButton", c)
equipBtn.Size = UDim2.new(0.6, -3, 0, 38)
equipBtn.Position = UDim2.new(0, 0, 0, 64)
equipBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 210)
equipBtn.BorderSizePixel = 0
equipBtn.Text = "âš¡ EQUIP"
equipBtn.TextColor3 = Color3.new(1, 1, 1)
equipBtn.TextSize = 15
equipBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", equipBtn).CornerRadius = UDim.new(0, 8)

local resetBtn = Instance.new("TextButton", c)
resetBtn.Size = UDim2.new(0.4, -3, 0, 38)
resetBtn.Position = UDim2.new(0.6, 3, 0, 64)
resetBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
resetBtn.BorderSizePixel = 0
resetBtn.Text = "â†º Reset"
resetBtn.TextColor3 = Color3.fromRGB(200, 200, 215)
resetBtn.TextSize = 14
resetBtn.Font = Enum.Font.GothamBold
Instance.new("UICorner", resetBtn).CornerRadius = UDim.new(0, 8)

-- ROW 2: Keep clothes toggle
local clothesToggle = Instance.new("TextButton", c)
clothesToggle.Size = UDim2.new(1, 0, 0, 26)
clothesToggle.Position = UDim2.new(0, 0, 0, 108)
clothesToggle.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
clothesToggle.BorderSizePixel = 0
clothesToggle.Text = "ðŸ‘• Keep Clothes: OFF (full bundle apply)"
clothesToggle.TextColor3 = Color3.fromRGB(150, 150, 175)
clothesToggle.TextSize = 11
clothesToggle.Font = Enum.Font.Gotham
Instance.new("UICorner", clothesToggle).CornerRadius = UDim.new(0, 6)

clothesToggle.MouseButton1Click:Connect(function()
    keepClothes = not keepClothes
    if keepClothes then
        clothesToggle.Text = "ðŸ‘• Keep Clothes: ON (body only)"
        clothesToggle.TextColor3 = Color3.fromRGB(80, 220, 120)
    else
        clothesToggle.Text = "ðŸ‘• Keep Clothes: OFF (full bundle apply)"
        clothesToggle.TextColor3 = Color3.fromRGB(150, 150, 175)
    end
end)

-- ROW 3: Quick presets label
local preLabel = Instance.new("TextLabel", c)
preLabel.Size = UDim2.new(1, 0, 0, 14)
preLabel.Position = UDim2.new(0, 0, 0, 140)
preLabel.BackgroundTransparency = 1
preLabel.Text = "QUICK PRESETS:"
preLabel.TextColor3 = Color3.fromRGB(120, 120, 150)
preLabel.TextSize = 10
preLabel.Font = Enum.Font.GothamBold
preLabel.TextXAlignment = Enum.TextXAlignment.Left

-- Quick button helper
local function qBtn(text, pos, color)
    local b = Instance.new("TextButton", c)
    b.Size = UDim2.new(0.333, -4, 0, 30)
    b.Position = pos
    b.BackgroundColor3 = color
    b.BorderSizePixel = 0
    b.Text = text
    b.TextColor3 = Color3.new(1, 1, 1)
    b.TextSize = 11
    b.Font = Enum.Font.GothamBold
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
    return b
end

-- Row A presets
local bHeadless = qBtn("ðŸ’€ Headless", UDim2.new(0, 0, 0, 158), Color3.fromRGB(130, 20, 150))
local bKorblox = qBtn("ðŸ¦´ Korblox", UDim2.new(0.333, 2, 0, 158), Color3.fromRGB(25, 80, 150))
local bSkeleton = qBtn("â˜  Skeleton", UDim2.new(0.666, 4, 0, 158), Color3.fromRGB(100, 100, 20))

-- Row B presets
local bKorLeg = qBtn("ðŸ¦¿ KorbLeg", UDim2.new(0, 0, 0, 192), Color3.fromRGB(25, 60, 120))
local bRthro = qBtn("ðŸ§ Man 2.0", UDim2.new(0.333, 2, 0, 192), Color3.fromRGB(40, 110, 50))
local bSuperhero = qBtn("ðŸ¦¸ Superhero", UDim2.new(0.666, 4, 0, 192), Color3.fromRGB(150, 40, 30))

-- STATUS
local statusFrame = Instance.new("Frame", c)
statusFrame.Size = UDim2.new(1, 0, 0, 75)
statusFrame.Position = UDim2.new(0, 0, 0, 230)
statusFrame.BackgroundColor3 = Color3.fromRGB(22, 22, 32)
statusFrame.BorderSizePixel = 0
Instance.new("UICorner", statusFrame).CornerRadius = UDim.new(0, 8)

local statusLabel = Instance.new("TextLabel", statusFrame)
statusLabel.Size = UDim2.new(1, -16, 1, -8)
statusLabel.Position = UDim2.new(0, 8, 0, 4)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Ready â€” Enter ID and press Equip\nSupports Bundle IDs + Asset IDs\nRightCtrl to toggle UI"
statusLabel.TextColor3 = Color3.fromRGB(120, 120, 150)
statusLabel.TextSize = 11
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextWrapped = true
statusLabel.TextYAlignment = Enum.TextYAlignment.Top

gui.Parent = player:WaitForChild("PlayerGui")

---------------------------------------------------------------
-- STATUS HELPER
---------------------------------------------------------------
local isProcessing = false

local function log(text, color)
    statusLabel.Text = text
    statusLabel.TextColor3 = color or Color3.fromRGB(120, 120, 150)
end

---------------------------------------------------------------
-- EQUIP LOGIC
---------------------------------------------------------------
local function runEquip(id)
    if isProcessing then return end
    isProcessing = true
    equipBtn.Text = "â³ Working..."
    equipBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)

    local ok, nameOrErr, method = pcall(equipAny, id, log)
    if ok then
        log("âœ… " .. tostring(nameOrErr) .. "\nMethod: " .. tostring(method), Color3.fromRGB(70, 255, 110))
    else
        log("âŒ " .. tostring(nameOrErr), Color3.fromRGB(255, 60, 60))
    end

    updateRigLabel()
    equipBtn.Text = "âš¡ EQUIP"
    equipBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 210)
    isProcessing = false
end

---------------------------------------------------------------
-- CONNECTIONS
---------------------------------------------------------------
equipBtn.MouseButton1Click:Connect(function()
    local id = tonumber(textBox.Text:match("%d+"))
    if not id then log("âŒ Enter a valid ID!", Color3.fromRGB(255, 60, 60)) return end
    runEquip(id)
end)

textBox.FocusLost:Connect(function(enter)
    if enter and not isProcessing then
        local id = tonumber(textBox.Text:match("%d+"))
        if id then runEquip(id) end
    end
end)

resetBtn.MouseButton1Click:Connect(function()
    if isProcessing then return end
    isProcessing = true
    resetBtn.Text = "..."

    local ok, err = pcall(doReset)
    if ok then
        log("âœ… Reset to original avatar", Color3.fromRGB(70, 255, 110))
    else
        log("Reset failed, respawning... " .. tostring(err), Color3.fromRGB(255, 180, 50))
        pcall(function()
            player.Character:FindFirstChildOfClass("Humanoid").Health = 0
        end)
    end

    updateRigLabel()
    resetBtn.Text = "â†º Reset"
    isProcessing = false
end)

bHeadless.MouseButton1Click:Connect(function()
    if isProcessing then return end
    isProcessing = true
    local ok, err = pcall(doHeadless)
    if ok then
        log("âœ… Headless applied!\nHead, face, and hair hidden", Color3.fromRGB(70, 255, 110))
    else
        log("âŒ " .. tostring(err), Color3.fromRGB(255, 60, 60))
    end
    isProcessing = false
end)

local presets = {
    {btn = bKorblox, id = 154},
    {btn = bSkeleton, id = 174},
    {btn = bKorLeg, id = 139607718},
    {btn = bRthro, id = 228},
    {btn = bSuperhero, id = 229},
}
for _, p in ipairs(presets) do
    p.btn.MouseButton1Click:Connect(function()
        textBox.Text = tostring(p.id)
        task.wait()
        runEquip(p.id)
    end)
end

closeBtn.MouseButton1Click:Connect(function() gui:Destroy() end)

UIS.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.RightControl then
        main.Visible = not main.Visible
    end
end)

print("[BundleEquipper v4] Loaded! Executor: " .. execName)
