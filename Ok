-- LocalScript: Place in StarterPlayerScripts or StarterGui
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RS = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer
local PGui = LP:WaitForChild("PlayerGui")

local toggleOn = false
local selName, selId, selSkin = "", "", ""
local dragging = false
local dragInput, dragStart, startPos
local savedCFrame = nil
local waitingForTP = false

local SG = Instance.new("ScreenGui")
SG.Name = "MorphGui"
SG.ResetOnSpawn = false
SG.Parent = PGui

local MF = Instance.new("Frame")
MF.Size = UDim2.new(0, 240, 0, 340)
MF.Position = UDim2.new(0.5, -120, 0.5, -170)
MF.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
MF.BorderSizePixel = 0
MF.Active = true
MF.Parent = SG
Instance.new("UICorner", MF).CornerRadius = UDim.new(0, 10)

local TB = Instance.new("Frame")
TB.Size = UDim2.new(1, 0, 0, 34)
TB.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
TB.BorderSizePixel = 0
TB.Parent = MF
Instance.new("UICorner", TB).CornerRadius = UDim.new(0, 10)

local TBfix = Instance.new("Frame")
TBfix.Size = UDim2.new(1, 0, 0, 10)
TBfix.Position = UDim2.new(0, 0, 1, -10)
TBfix.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
TBfix.BorderSizePixel = 0
TBfix.Parent = TB

local TL = Instance.new("TextLabel")
TL.Size = UDim2.new(1, -40, 1, 0)
TL.Position = UDim2.new(0, 8, 0, 0)
TL.BackgroundTransparency = 1
TL.Text = "Morph Tool"
TL.TextColor3 = Color3.new(1, 1, 1)
TL.TextSize = 14
TL.Font = Enum.Font.GothamBold
TL.TextXAlignment = Enum.TextXAlignment.Left
TL.Parent = TB

TB.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		dragInput = input
		startPos = MF.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				if dragInput == input then
					dragging = false
					dragInput = nil
				end
			end
		end)
	end
end)

TB.InputChanged:Connect(function(input)
	if dragging and input == dragInput then
		local d = input.Position - dragStart
		MF.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
	end
end)

UIS.InputChanged:Connect(function(input)
	if dragging and input == dragInput then
		local d = input.Position - dragStart
		MF.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
	end
end)

local minBtn = Instance.new("TextButton")
minBtn.Size = UDim2.new(0, 24, 0, 24)
minBtn.Position = UDim2.new(1, -30, 0, 5)
minBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
minBtn.Text = "-"
minBtn.TextColor3 = Color3.new(1, 1, 1)
minBtn.TextSize = 14
minBtn.Font = Enum.Font.GothamBold
minBtn.BorderSizePixel = 0
minBtn.Parent = TB
Instance.new("UICorner", minBtn).CornerRadius = UDim.new(0, 6)

local content = Instance.new("Frame")
content.Size = UDim2.new(1, -16, 1, -42)
content.Position = UDim2.new(0, 8, 0, 38)
content.BackgroundTransparency = 1
content.Parent = MF

local isMin = false
minBtn.MouseButton1Click:Connect(function()
	isMin = not isMin
	content.Visible = not isMin
	if isMin then
		MF:TweenSize(UDim2.new(0, 240, 0, 34), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.25, true)
		minBtn.Text = "+"
	else
		MF:TweenSize(UDim2.new(0, 240, 0, 340), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.25, true)
		minBtn.Text = "-"
	end
end)

local togFrame = Instance.new("Frame")
togFrame.Size = UDim2.new(1, 0, 0, 36)
togFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
togFrame.BorderSizePixel = 0
togFrame.Parent = content
Instance.new("UICorner", togFrame).CornerRadius = UDim.new(0, 7)

local togLbl = Instance.new("TextLabel")
togLbl.Size = UDim2.new(1, -55, 1, 0)
togLbl.Position = UDim2.new(0, 8, 0, 0)
togLbl.BackgroundTransparency = 1
togLbl.Text = "Click Player"
togLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
togLbl.TextSize = 12
togLbl.Font = Enum.Font.GothamSemibold
togLbl.TextXAlignment = Enum.TextXAlignment.Left
togLbl.Parent = togFrame

local togBg = Instance.new("Frame")
togBg.Size = UDim2.new(0, 40, 0, 20)
togBg.Position = UDim2.new(1, -48, 0.5, -10)
togBg.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
togBg.BorderSizePixel = 0
togBg.Parent = togFrame
Instance.new("UICorner", togBg).CornerRadius = UDim.new(1, 0)

local togCirc = Instance.new("Frame")
togCirc.Size = UDim2.new(0, 16, 0, 16)
togCirc.Position = UDim2.new(0, 2, 0.5, -8)
togCirc.BackgroundColor3 = Color3.fromRGB(160, 160, 160)
togCirc.BorderSizePixel = 0
togCirc.Parent = togBg
Instance.new("UICorner", togCirc).CornerRadius = UDim.new(1, 0)

local togBtn = Instance.new("TextButton")
togBtn.Size = UDim2.new(1, 0, 1, 0)
togBtn.BackgroundTransparency = 1
togBtn.Text = ""
togBtn.Parent = togBg

local statusLbl = Instance.new("TextLabel")
statusLbl.Size = UDim2.new(1, 0, 0, 18)
statusLbl.Position = UDim2.new(0, 0, 0, 40)
statusLbl.BackgroundTransparency = 1
statusLbl.Text = "Inactive"
statusLbl.TextColor3 = Color3.fromRGB(130, 130, 130)
statusLbl.TextSize = 11
statusLbl.Font = Enum.Font.Gotham
statusLbl.TextXAlignment = Enum.TextXAlignment.Left
statusLbl.Parent = content

togBtn.MouseButton1Click:Connect(function()
	toggleOn = not toggleOn
	if toggleOn then
		togBg.BackgroundColor3 = Color3.fromRGB(40, 160, 70)
		togCirc:TweenPosition(UDim2.new(1, -18, 0.5, -8), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.2, true)
		togCirc.BackgroundColor3 = Color3.new(1, 1, 1)
		statusLbl.Text = "Tap a player!"
		statusLbl.TextColor3 = Color3.fromRGB(80, 255, 80)
	else
		togBg.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
		togCirc:TweenPosition(UDim2.new(0, 2, 0.5, -8), Enum.EasingDirection.Out, Enum.EasingStyle.Quint, 0.2, true)
		togCirc.BackgroundColor3 = Color3.fromRGB(160, 160, 160)
		statusLbl.Text = "Inactive"
		statusLbl.TextColor3 = Color3.fromRGB(130, 130, 130)
	end
end)

local thumbFrame = Instance.new("Frame")
thumbFrame.Size = UDim2.new(0, 56, 0, 56)
thumbFrame.Position = UDim2.new(0.5, -28, 0, 62)
thumbFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
thumbFrame.BorderSizePixel = 0
thumbFrame.Parent = content
Instance.new("UICorner", thumbFrame).CornerRadius = UDim.new(1, 0)

local thumbImg = Instance.new("ImageLabel")
thumbImg.Size = UDim2.new(1, -4, 1, -4)
thumbImg.Position = UDim2.new(0, 2, 0, 2)
thumbImg.BackgroundTransparency = 1
thumbImg.Image = ""
thumbImg.ScaleType = Enum.ScaleType.Fit
thumbImg.Parent = thumbFrame
Instance.new("UICorner", thumbImg).CornerRadius = UDim.new(1, 0)

local nameLbl = Instance.new("TextLabel")
nameLbl.Size = UDim2.new(1, 0, 0, 16)
nameLbl.Position = UDim2.new(0, 0, 0, 122)
nameLbl.BackgroundTransparency = 1
nameLbl.Text = "Name: N/A"
nameLbl.TextColor3 = Color3.fromRGB(190, 190, 190)
nameLbl.TextSize = 11
nameLbl.Font = Enum.Font.Gotham
nameLbl.TextXAlignment = Enum.TextXAlignment.Left
nameLbl.Parent = content

local idLbl = Instance.new("TextLabel")
idLbl.Size = UDim2.new(1, 0, 0, 16)
idLbl.Position = UDim2.new(0, 0, 0, 140)
idLbl.BackgroundTransparency = 1
idLbl.Text = "ID: N/A"
idLbl.TextColor3 = Color3.fromRGB(190, 190, 190)
idLbl.TextSize = 11
idLbl.Font = Enum.Font.Gotham
idLbl.TextXAlignment = Enum.TextXAlignment.Left
idLbl.Parent = content

local skinLbl = Instance.new("TextLabel")
skinLbl.Size = UDim2.new(1, 0, 0, 16)
skinLbl.Position = UDim2.new(0, 0, 0, 158)
skinLbl.BackgroundTransparency = 1
skinLbl.Text = "Skin: N/A"
skinLbl.TextColor3 = Color3.fromRGB(190, 190, 190)
skinLbl.TextSize = 11
skinLbl.Font = Enum.Font.Gotham
skinLbl.TextXAlignment = Enum.TextXAlignment.Left
skinLbl.TextTruncate = Enum.TextTruncate.AtEnd
skinLbl.Parent = content

local idInput = Instance.new("TextBox")
idInput.Size = UDim2.new(1, 0, 0, 28)
idInput.Position = UDim2.new(0, 0, 0, 180)
idInput.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
idInput.BorderSizePixel = 0
idInput.PlaceholderText = "Player ID (any player)"
idInput.PlaceholderColor3 = Color3.fromRGB(100, 100, 120)
idInput.Text = ""
idInput.TextColor3 = Color3.new(1, 1, 1)
idInput.TextSize = 11
idInput.Font = Enum.Font.Gotham
idInput.ClearTextOnFocus = false
idInput.Parent = content
Instance.new("UICorner", idInput).CornerRadius = UDim.new(0, 6)

local skinInput = Instance.new("TextBox")
skinInput.Size = UDim2.new(1, 0, 0, 28)
skinInput.Position = UDim2.new(0, 0, 0, 212)
skinInput.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
skinInput.BorderSizePixel = 0
skinInput.PlaceholderText = "Skin Name"
skinInput.PlaceholderColor3 = Color3.fromRGB(100, 100, 120)
skinInput.Text = ""
skinInput.TextColor3 = Color3.new(1, 1, 1)
skinInput.TextSize = 11
skinInput.Font = Enum.Font.Gotham
skinInput.ClearTextOnFocus = false
skinInput.Parent = content
Instance.new("UICorner", skinInput).CornerRadius = UDim.new(0, 6)

local morphBtn = Instance.new("TextButton")
morphBtn.Size = UDim2.new(1, 0, 0, 36)
morphBtn.Position = UDim2.new(0, 0, 0, 248)
morphBtn.BackgroundColor3 = Color3.fromRGB(40, 110, 190)
morphBtn.BorderSizePixel = 0
morphBtn.Text = "MORPH"
morphBtn.TextColor3 = Color3.new(1, 1, 1)
morphBtn.TextSize = 14
morphBtn.Font = Enum.Font.GothamBold
morphBtn.Parent = content
Instance.new("UICorner", morphBtn).CornerRadius = UDim.new(0, 7)

local resLbl = Instance.new("TextLabel")
resLbl.Size = UDim2.new(1, 0, 0, 14)
resLbl.Position = UDim2.new(0, 0, 0, 288)
resLbl.BackgroundTransparency = 1
resLbl.Text = ""
resLbl.TextColor3 = Color3.fromRGB(100, 255, 100)
resLbl.TextSize = 10
resLbl.Font = Enum.Font.Gotham
resLbl.TextWrapped = true
resLbl.Parent = content

local function setThumb(userId)
	local ok, url = pcall(function()
		return Players:GetUserThumbnailAsync(tonumber(userId), Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
	end)
	thumbImg.Image = (ok and url) or ""
end

-- The KEY fix: the character model name IS the skin name
-- That skin name is actually another player's username
-- So we look up that username to get their ID (works for ANY roblox player)
local function selectFromCharacter(character)
	if not character then return end
	local skinName = character.Name -- THIS is the skin = another player's name

	-- Look up the ID of that skin name (works offline/online/any player)
	local foundId = ""
	local foundName = skinName

	local ok, userId = pcall(function()
		return Players:GetUserIdFromNameAsync(skinName)
	end)

	if ok and userId then
		foundId = tostring(userId)
		foundName = skinName
	else
		-- Maybe character name has display name, try descendants
		for _, v in pairs(character:GetDescendants()) do
			if (v:IsA("StringValue") or v:IsA("IntValue")) then
				local n = v.Name:lower()
				if n:find("skin") or n:find("morph") or n:find("owner") or n:find("original") then
					local tryName = tostring(v.Value)
					local ok2, uid2 = pcall(function()
						return Players:GetUserIdFromNameAsync(tryName)
					end)
					if ok2 and uid2 then
						foundId = tostring(uid2)
						foundName = tryName
						skinName = tryName
						break
					end
				end
			end
		end
	end

	selName = foundName
	selId = foundId
	selSkin = skinName
	nameLbl.Text = "Name: " .. selName
	idLbl.Text = "ID: " .. selId
	skinLbl.Text = "Skin: " .. selSkin
	idInput.Text = selId
	skinInput.Text = selSkin
	resLbl.Text = "Selected!"
	resLbl.TextColor3 = Color3.fromRGB(100, 255, 100)
	if foundId ~= "" then setThumb(foundId) end
end

local mouse = LP:GetMouse()
mouse.Button1Down:Connect(function()
	if not toggleOn then return end
	local t = mouse.Target
	if not t then return end
	local char = t:FindFirstAncestorOfClass("Model")
	if not char or not char:FindFirstChildOfClass("Humanoid") then return end
	if LP.Character and char == LP.Character then return end
	selectFromCharacter(char)
end)

UIS.TouchTapInWorld:Connect(function(pos, processed)
	if not toggleOn or processed then return end
	local cam = workspace.CurrentCamera
	local ray = cam:ViewportPointToRay(pos.X, pos.Y)
	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Exclude
	params.FilterDescendantsInstances = {LP.Character or Instance.new("Folder")}
	local res = workspace:Raycast(ray.Origin, ray.Direction * 500, params)
	if res and res.Instance then
		local char = res.Instance:FindFirstAncestorOfClass("Model")
		if char and char:FindFirstChildOfClass("Humanoid") then
			if LP.Character and char == LP.Character then return end
			selectFromCharacter(char)
		end
	end
end)

-- TELEPORT FIX: CharacterAdded fires when morph resets you
-- We wait for HumanoidRootPart then keep teleporting until it sticks
LP.CharacterAdded:Connect(function(char)
	if not waitingForTP or not savedCFrame then return end
	local hrp = char:WaitForChild("HumanoidRootPart", 10)
	if not hrp then return end
	-- Spam teleport to make sure it sticks after respawn
	for i = 1, 20 do
		task.wait(0.15)
		if hrp and hrp.Parent then
			hrp.CFrame = savedCFrame
		end
	end
	waitingForTP = false
	resLbl.Text = "Morphed + Teleported!"
	resLbl.TextColor3 = Color3.fromRGB(100, 255, 100)
end)

morphBtn.MouseButton1Click:Connect(function()
	local fId = idInput.Text:gsub("%s", "")
	local fSkin = skinInput.Text

	if fId == "" then
		resLbl.Text = "Enter an ID or tap a player!"
		resLbl.TextColor3 = Color3.fromRGB(255, 200, 50)
		return
	end
	if fSkin == "" then
		resLbl.Text = "Enter a skin name!"
		resLbl.TextColor3 = Color3.fromRGB(255, 200, 50)
		return
	end

	-- Save position NOW before morph
	if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
		savedCFrame = LP.Character.HumanoidRootPart.CFrame
	end
	waitingForTP = true

	if tonumber(fId) then
		setThumb(fId)
		local ok, n = pcall(function()
			return Players:GetNameFromUserIdAsync(tonumber(fId))
		end)
		if ok and n then nameLbl.Text = "Name: " .. n end
	end
	idLbl.Text = "ID: " .. fId
	skinLbl.Text = "Skin: " .. fSkin

	local ok, err = pcall(function()
		RS.SendCharMorphEvent:FireServer(fId, fSkin)
	end)

	if ok then
		morphBtn.BackgroundColor3 = Color3.fromRGB(30, 180, 80)
		morphBtn.Text = "SENT!"
		resLbl.Text = "Morphing + will teleport..."
		resLbl.TextColor3 = Color3.fromRGB(100, 200, 255)
		task.delay(1.5, function()
			morphBtn.BackgroundColor3 = Color3.fromRGB(40, 110, 190)
			morphBtn.Text = "MORPH"
		end)
	else
		waitingForTP = false
		resLbl.Text = "Error: " .. tostring(err)
		resLbl.TextColor3 = Color3.fromRGB(255, 80, 80)
	end
end)

idInput.FocusLost:Connect(function()
	local id = idInput.Text:gsub("%s", "")
	if tonumber(id) then
		setThumb(id)
		local ok, n = pcall(function()
			return Players:GetNameFromUserIdAsync(tonumber(id))
		end)
		if ok and n then
			nameLbl.Text = "Name: " .. n
			idLbl.Text = "ID: " .. id
			resLbl.Text = "Loaded: " .. n
			resLbl.TextColor3 = Color3.fromRGB(180, 150, 255)
		end
	end
end)

MF.Size = UDim2.new(0, 0, 0, 0)
MF.Position = UDim2.new(0.5, 0, 0.5, 0)
MF:TweenSizeAndPosition(UDim2.new(0, 240, 0, 340), UDim2.new(0.5, -120, 0.5, -170), Enum.EasingDirection.Out, Enum.EasingStyle.Back, 0.4, true)
